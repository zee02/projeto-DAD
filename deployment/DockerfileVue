FROM oven/bun:1 AS build-stage
WORKDIR /app

# Build-time config (passed via --build-arg)
ARG VITE_API_DOMAIN="localhost:8000"
ARG VITE_WS_CONNECTION="ws://localhost:3000"

COPY package.json package-lock.json* ./
RUN rm -rf node_modules .bun && bun install --frozen-lockfile

COPY . .

# Remove local env files that might override build args
RUN rm -f .env.local

# Create .env.production with the build args
RUN echo "VITE_API_DOMAIN=${VITE_API_DOMAIN}" > .env.production && \
    echo "VITE_WS_CONNECTION=${VITE_WS_CONNECTION}" >> .env.production

# Build with production mode
RUN bun run build

FROM nginx:alpine
COPY --from=build-stage /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80